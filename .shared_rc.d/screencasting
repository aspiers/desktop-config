# -*- mode: sh -*-

ffx-help () {
    cat <<EOF
Run ffx-full, or ffx-winselect, or ffx-rectselect, or set:

  ffx_geometry=$ffx_geometry
  ffx_viewport=$ffx_viewport

To set a window to 1280 by 720:

  # allow border of 1 by 23 with openbox (full decoration is 1+1 by 20+5)
  xdotool search --onlyvisible chrome windowsize 1281 697
  # or:
  xdotool windowselect windowsize 1281 697

To produce a reference window of a given size:

  c=red; xeyes +shape -bg $c -outline $c -fg $c -geometry 1280x720+50+50

(but don't forget to undecorate the window since decorations expand it!)

Run ffx-pulse (default), or

  ffx-alsa hw:0,0  # cat /proc/asound/pcm

To record:

  file=foo.mp4; sleep 2; ffx [extra ffmpeg options] $file && mplayer $file

Upscale to 1080p to prevent YouTube from destroying quality (doh!):

  ffmpeg -i $file -vf scale=1920:1080 ${file%.*}-1080.${file##*.}

Extract a frame for thumbnail:

  ffmpeg -ss 00:01:23 -i $file -t 1 -r 1 frame%d.png
EOF
}

# see also https://github.com/lolilolicon/FFcast2

# https://github.com/gotbletu/shownotes/blob/master/ffmpeg_x11grab_screencast.txt

# Settings recommended for YouTube
# https://support.google.com/youtube/answer/1722171?hl=en
ffx_channels="1"           # mono / stereo audio
ffx_fps="30"               # frames per second
ffx_acodec="flac"          # audio codec
#ffx_acodec="pcm_s16le"

# settings recommended for YouTube:
# https://support.google.com/youtube/answer/1722171?hl=en
ffx_vcodec="libx264" 
ffx_preset="slow"          # preset error? run 'x264 -h' replace with fast,superfast, slow ..etc
                           # - requires x264 installed.
ffx_crf="18"               # quality for constant quality mode
ffx_profile="high"         # h264 profile

#ffx_scale="scale=1280:720" # scale resolution, no black bars on sides of video on youtube
ffx_geometry=1280x720      # ideal for YouTube; overwritten by ffx-{full,winselect}
ffx_viewport=+0+0          # easy-to-use default

ffx-alsa () {
    audio_input_opts=(
        -f alsa
        -i "$1"
    )
}

ffx-pulse () {
    # Needs to be compiled with --enable-libpulse
    # https://www.ffmpeg.org/ffmpeg-devices.html#pulse
    audio_input_opts=(
        -f pulse
        -i default # lots of people use 'pulse' but that doesn't work for me
    )
}

#ffx-alsa hw:2,1
ffx-pulse

ffx-full () {
    ffx_wininfo="$( xwininfo -root )"
    ffx_viewport=
    _ffx_geom_from_wininfo
    _ffx_report_geom_viewport
}

ffx-winselect () {
    ffx_wininfo="$(xwininfo -frame)"
    ffx_top_left_x=$(
        echo "$ffx_wininfo" | \
            awk '/Absolute upper-left X: / { print $4 }'
    )
    ffx_top_left_y=$(
        echo "$ffx_wininfo" | \
            awk '/Absolute upper-left Y: / { print $4 }'
    )
    ffx_viewport="+$ffx_top_left_x+$ffx_top_left_y"
    _ffx_geom_from_wininfo
    _ffx_report_geom_viewport
}

ffx-rectselect () {
    ffx_wininfo="$(xrectsel)"
    ffx_geometry="${ffx_wininfo%%+*}"
    ffx_viewport="+${ffx_wininfo#*+}"
    _ffx_report_geom_viewport
}

_ffx_geom_from_wininfo () {
    ffx_geometry=$(
        echo "$ffx_wininfo" | \
            awk '/-geometry/ {print $2}' | \
            grep -oEe '[0-9]+x[0-9]+'
    )
}

_ffx_report_geom_viewport () {
    echo "Geometry: $ffx_geometry"
    echo "Viewport: $ffx_viewport"
}

ffx () {
    ffmpeg_opts=(
        # audio options
        "${audio_input_opts[@]}"
        -ac $ffx_channels
        -acodec $ffx_acodec

        # video options
        -f x11grab
        -video_size $ffx_geometry # has to be after x11 grab and before -i!
        -framerate $ffx_fps
        -i $DISPLAY$ffx_viewport
        #-vf $ffx_scale

        -vcodec $ffx_vcodec # has to come after -i for some reason
        -preset $ffx_preset
        -profile:v $ffx_profile
        -crf $ffx_crf  # quality for constant quality mode
        -pix_fmt yuv420p

        -r $ffx_fps

        # general options
        "$@"
    )

    echo ffmpeg "${ffmpeg_opts[@]}"
    ffmpeg "${ffmpeg_opts[@]}"
}
