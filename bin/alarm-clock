#!/bin/sh

me=`basename $0`

usage () {
    if [ -n "$1" ]; then
        echo "$*" >&2
        echo
    fi

cat <<EOF >&2
Usage: $me [options] TIME TRACK
Options
  -p, --preview    Preview the track before scheduling the alarm
EOF
    exit 1
}

if [ "$1" == '-h' ] || [ "$1" == '--help' ]; then
    usage
fi

if [ "$1" = '-p' ] || [ "$1" = '--preview' ]; then
    preview=yes
    shift
fi

if [ $# -ne 2 ]; then
    usage
fi

time="$1"
track="$2"

case "$track" in
    *.mp3) player=mpg123 ;;
    *.ogg) player=ogg    ;;
    *)
        echo "${track##*.} not supported" >&2
        exit 1
        ;;
esac

if [ -n "$preview" ]; then
    "$player" "$track"
    echo
    echo -n "Press Enter to schedule the alarm ... "
    read
fi

at "$time" <<EOF
quietrun $player "$track"
EOF

atq
