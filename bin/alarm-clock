#!/bin/sh

me=`basename $0`

usage () {
    if [ -n "$1" ]; then
        echo "$*" >&2
        echo
    fi

cat <<EOF >&2
Usage: $me [options] TIME TRACK [TRACK...]
Options
  -p, --preview    Preview the track before scheduling the alarm
EOF
    exit 1
}

if [ "$1" == '-h' ] || [ "$1" == '--help' ]; then
    usage
fi

if [ "$1" = '-p' ] || [ "$1" = '--preview' ]; then
    preview=yes
    shift
fi

if [ $# -lt 1 ]; then
    usage
fi

time="$1"
shift

# case "$track" in
#     *.mp3) player=mpg123 ;;
#     *.ogg) player=ogg123 ;;
#     *)
#         echo "${track##*.} not supported" >&2
#         exit 1
#         ;;
# esac
#player="mplayer -ao pulse"
player="mpc play"

if [ -n "$preview" ]; then
    $player "$@"
    echo
    echo -n "Press Enter to schedule the alarm ... "
    read
fi

args=
for track in "$@"; do
    if [ -z "$args" ]; then
        args="\"$track\""
    else
        args="$args \"$track\""
    fi
done

at $time <<EOF
quietrun $player $args </dev/null
EOF

atq
