#!/bin/bash

# Extract and set DPI from layout configuration
# Usage: set-layout-dpi [layout_name]
# If no layout_name is provided, get current layout using bin/get-layout

fallback_dpi() {
    . ~/lib/libhost.sh
    if host-has-prop laptop; then
        if BenQ-connected; then
            echo "Setting DPI to 84 (BenQ connected)"
            set-xfce4-dpi 84
        elif large-monitor-connected; then
            echo "Setting DPI to 128 (large monitor connected)"
            set-xfce4-dpi 128
        else
            echo "Setting DPI to 128 (default laptop)"
            set-xfce4-dpi 128
        fi
    else
        echo "Non-laptop host, no DPI adjustment needed"
    fi
}

set_dpi_for_layout() {
    local layout_file="$1"
    local layout="$2"

    # First try: DPI from layout file
    local dpi=$(grep -E '^[[:space:]]*dpi:' "$layout_file" | sed 's/.*dpi:[[:space:]]*//')
    if [ -n "$dpi" ]; then
        echo "Setting DPI to $dpi for layout $layout"
        set-xfce4-dpi "$dpi"
        return 0
    fi

    echo "No DPI setting found in layout file, detecting from primary screen"

    # Second try: DPI from primary screen
    local primary_json
    if ! primary_json=$(~/lib/libdpy.py --find-inxi-primary 2>/dev/null); then
        echo "Failed to get primary screen info"
        return 1
    fi

    local detected_dpi=$(echo "$primary_json" | jq -r '.dpi // empty')
    if [ -z "$detected_dpi" ] || [ "$detected_dpi" -le 0 ]; then
        echo "Could not detect DPI from primary screen"
        return 1
    fi

    echo "Detected DPI $detected_dpi from primary screen"
    set-xfce4-dpi "$detected_dpi"
    return 0
}

main() {
    if [ $# -eq 0 ]; then
        echo -n "Getting current layout ... "
        if ! layout_file=$( get-layout ); then
            echo "failed"
            exit 1
        fi
        layout=$(basename -s .yaml "$layout_file")
        echo "$layout"
    elif [ $# -eq 1 ]; then
        layout="$1"
    else
        echo "Usage: $0 [layout_name]" >&2
        echo "Example: $0 celtic+large" >&2
        echo "If no layout_name is provided, current layout is detected automatically" >&2
        exit 1
    fi
    layout_file="$HOME/.fluxbox/layouts/${layout}.yaml"

    if [ ! -f "$layout_file" ]; then
        echo "Error: Layout file $layout_file not found" >&2
        exit 1
    fi

    if ! set_dpi_for_layout "$layout_file" "$layout"; then
        echo "Using fallback logic"
        fallback_dpi
    fi
}

main "$@"
