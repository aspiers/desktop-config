#!/bin/zsh

INITIAL_SLEEP=0.5
MAX_SLEEP=4

debug () {
    echo "\e[1;33m$*\e[0m"
}

error () {
    echo "\e[1;31mERROR: $*\e[0m" >&2
}

info () {
    echo "\e[1;34m$*\e[0m"
    notify-send -a "$me" -t 8000 "$*"
}

is_running () {
    pgrep -x "$1" >/dev/null
}

ensure_stopped () {
    local proc="$1"
    local timeout="${2:-20}"
    local secs=$INITIAL_SLEEP
    local waited=0
    while pid=$( is_running "$proc" ); do
        debug "Waiting ${secs}s for $proc (pid $pid) to stop running (waited ${waited}s, timeout ${timeout}s)"
        sleep $secs
        waited=$(echo "$waited + $secs" | bc -l)
        if (( $(echo "$waited >= $timeout" | bc -l) )); then
            error "Timeout waiting for $proc to stop (waited $waited >= $timeout seconds)"
            return 1
        fi
        if (( $(echo "$secs < $MAX_SLEEP" | bc -l) )); then
            secs=$(echo "$secs * 2" | bc)
            debug "Doubled sleep to $secs seconds"
        fi
    done
}

ensure_fluxbox_stopped () {
    info "Attempting to stop fluxbox via fluxbox-remote Exit"
    fluxbox-remote Exit
    if ensure_stopped fluxbox 1; then
        return 0
    fi

    info "Attempting to stop fluxbox via pkill -x fluxbox"
    pkill -x fluxbox
    if ensure_stopped fluxbox 3; then
        return 0
    fi

    info "Attempting to stop fluxbox via pkill -9x fluxbox"
    pkill -9x fluxbox
    if ensure_stopped fluxbox 10; then
        return 0
    fi

    error "Failed to stop fluxbox via multiple methods"
    exit 1
}

ensure_started () {
    local proc="$1"
    local timeout="${2:-20}"
    local secs=$INITIAL_SLEEP
    local waited=0
    while ! pid=$( is_running "$proc" ); do
        info "Waiting ${secs}s for $proc to start (waited ${waited}s, timeout ${timeout}s)"
        sleep $secs
        waited=$(echo "$waited + $secs" | bc -l)
        if (( $(echo "$waited >= $timeout" | bc -l) )); then
            error "Timeout waiting for $proc to start (waited $waited >= $timeout seconds)"
            exit 1
        fi
        if (( $(echo "$secs < $MAX_SLEEP" | bc -l) )); then
            secs=$(echo "$secs * 2" | bc)
            debug "Doubled sleep to $secs seconds"
        fi
    done
    info "$proc started (pid $$)"
}

main () {
    me=$(basename $0)

    : $0 pid is $$

    if [ -n "$SSH_CONNECTION" ]; then
        error "\$SSH_CONNECTION is set to $SSH_CONNECTION; cowardly aborting."
        exit 1
    fi

    # Needed to fix corrupted xfce4-panel which happens after display
    # reconfiguration.  Solution is to switch back to xfwm4 for a
    # second, then back to fluxbox.

    if is_running fluxbox; then
        ensure_fluxbox_stopped

        if [ -z "$no_xfwm" ]; then
            info "Replacing fluxbox with xfwm4"
            ( xfwm4 >& ~/.log/fluxbox-restart-xfwm4.log & )
            ensure_started xfwm4 10
        fi
    fi

    if is_running xfwm4; then
        sleep 1
        set-session-restart-style xfwm4 never
        sleep 1
        info "Stopping xfwm4"
        pkill xfwm4
        ensure_stopped xfwm4 5
    fi

    info "Starting fluxbox"
    systemd-run --user --scope --unit=fluxbox-$$ \
        fluxbox -log ~/.log/fluxbox.log </dev/null >&! ~/.log/fluxbox.log &

    sleep 1
    xdotool search \
            --onlyvisible \
            --screen 0 \
            --class \
            --classname 'Wrapper-2.0' \
            getwindowpid |
        xargs -r kill
}

main "$@"
