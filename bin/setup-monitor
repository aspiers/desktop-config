#!/bin/bash

#exec >& ~/.log/setup-monitor.log

echo -n "Getting layout ... "
if ! layout=$( get-layout ); then
    exit 1
fi

layout=$(basename -s .yaml "$layout")
echo "$layout"

# FIXME: replace the below with dynamic xrandr and xfconf commands based
# on config within the layout file.  The xrandr outputs should be discovered
# dynamically based on model name.
celtic_width=2880
celtic_height=1920
celtic_size="${celtic_width}x${celtic_height}"
BenQ_width=2560

eval $(~/lib/libdpy.py)

# Validate layout against current xrandr state (checks screen count matches)
if ! ~/lib/liblayout.py --check-screen-counts "$layout" >/dev/null; then
    echo "ERROR: Layout '$layout' validation failed" >&2
    echo "This usually means 'xrandr --auto' hasn't been run to activate all connected monitors" >&2
    echo "Run 'xrandr --auto' and clear the libdpy cache, or check monitor-watcher logs" >&2
    exit 1
fi

case "$layout" in
    celtic)
        xrandr \
            --output ${screen_0_name} --pos 0x0 --scale 1 --size $celtic_size --primary --auto
        ;;
    celtic+external)
        xrandr \
            --output ${screen_0_name} --pos 0x0 --scale 1 --size $celtic_size --auto \
            --output ${screen_1_name} --pos ${celtic_width}x0 --scale 1 --primary --auto
        ;;
    celtic+BenQ)
        xrandr \
            --output ${screen_0_name} --pos 0x0 --scale 1 --size $celtic_size --auto \
            --output ${screen_1_name} --pos ${celtic_width}x0 --scale 1 --primary --auto
        ;;
    celtic+BenQ+Dell)
        xrandr \
            --output ${screen_0_name} --pos 0x0 --scale 1 --size $celtic_size --auto \
            --output ${screen_1_name} --pos ${celtic_width}x0 --scale 1 --primary --auto \
            --output ${screen_2_name} --pos $(( celtic_width + BenQ_width ))x0 --scale 1 --auto
        # Alternate setup where laptop screen is off
        # xrandr \
        #     --output ${screen_0_name} --pos 0x0 --scale 1 --off \
        #     --output ${screen_1_name} --pos 0x0 --scale 1 --primary --auto \
        #     --output ${screen_2_name} --pos ${BenQ_width}x0 --scale 1 --auto
        ;;
    ionian)
        xrandr \
            --output DP-0 --pos 0x0 --scale 1 --primary --auto \
            --output DP-2.8 --pos 2560x0 --scale 1 --auto
        ;;
    *)
        echo "setup-monitor: don't know how to handle layout $layout"
        exit 1
        ;;
esac

# xrandr might have reordered the screens (since libdpy orders by
# xoffset) - cache should already be current from monitor-watcher
eval $(~/lib/libdpy.py)

. ~/lib/libhost.sh
read_localhost_nickname

setup_overlay() {
    local layout="$1"

    # Highest priority: layout-specific overlay
    if [ -e ~/.fluxbox/overlay.$layout ]; then
        ln -sf overlay.$layout ~/.fluxbox/overlay
        return
    fi

    # Second priority: host-specific overlay
    if [ -e ~/.fluxbox/overlay.$localhost_nickname ]; then
        ln -sf overlay.$localhost_nickname ~/.fluxbox/overlay
        return
    fi

    # Fallback: generate dynamically based on DPI
    echo "Generating dynamic overlay"
    local scale_factor=$(~/lib/libdpy.py --calculate-ui-scale)
    local base_font=10
    local title_font=$(printf "%.0f" $(echo "$base_font * $scale_factor" | bc))
    local menu_font=$(printf "%.0f" $(echo "($base_font + 1) * $scale_factor" | bc))

    cat > ~/.fluxbox/overlay <<EOF
window.borderWidth:               1
window.handleWidth:               8
window.font:                      sans-${title_font}:bold
window.title.height:              $(( 24 + (title_font - 10) * 2 ))
menu.title.font:                  sans-${title_font}:bold
menu.frame.font:                  sans-${menu_font}
menu.titleHeight:                 $(( 20 + (title_font - 10) * 2 ))
menu.itemHeight:                  10
EOF
}

setup_keyboard () {
    if host-has-prop laptop; then
        if BenQ-connected; then
            # Connect to Kinesis Advantage 360 over Bluetooth
            adv &
        else
            adv off &
        fi
    fi
}

main () {
    setup_overlay "$layout"
    setup-panels
    setup_keyboard
    set-layout-dpi "$layout"

    sleep 1

    fluxbox-reconfigure  # update ~/.fluxbox/keys

    echo "Loading as-fonts via emacsclient ..."
    emacsclient -e '(load "as-fonts")'

    echo "Fluxbox restart ..."
    fr

    sleep 1

    echo "Fluxbox layout ..."
    run-with-local-X-display ly

    echo "Restarting xfce4-panel ..."
    xfce4-panel -r

    pkill nm-applet
    nm-applet >&~/.log/nm-applet.log &
}

main
