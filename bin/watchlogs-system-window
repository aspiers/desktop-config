#!/bin/bash

. $ZDOTDIR/lib/libdpy.sh

font=smoothansi

eval $( get-font-geometry $font )

# Take 20% of height:
watchlogs_height_px=$(( dpy_height / 5 ))
watchlogs_height=$(( watchlogs_height_px / font_char_height ))

# Maybe allow some space on the right for gkrellm
right_margin=0
#right_margin=90
watchlogs_width_px=$(( dpy_width - right_margin ))
watchlogs_width=$(( watchlogs_width_px / font_char_width ))

if [[ "$DESKTOP_SESSION" == *gnome* ]] &&
   pgrep -u $UID gnome-panel >/dev/null
then
    panel=

    for key in bottom_panel{,_screen0}; do
        # Fedora 10 has bottom_panel
        # SLES 11   has bottom_panel_screen0
        top=/apps/panel/toplevels
        if gconftool-2 --dir-exists=$top/$key; then
            panel=$top/$key
            break
        fi
    done

    if [ -z "$panel" ]; then
        echo "Couldn't find gconf key for bottom panel; guessing margin of 7px"
        bottom_margin=7
    else
        auto_hide="`gconftool-2 -g $panel/auto_hide`"
        if [ "$auto_hide" = 'true' ]; then
            echo "Panel auto-hidden; using bottom margin of 7px"
            bottom_margin=7
        else
            height="`gconftool-2 -g $panel/size`"
            echo "Panel not auto-hidden; using bottom margin of ${height}px"
            bottom_margin=$height
        fi
    fi    
else
    # FIXME: kde
    bottom_margin=0
fi

# Old style fake transparency: -tr -tint white -sh 70
#
# New style is full alpha transparency but needs composite extension
# and a compositing manager such as xcompmgr running.  Note that this
# can normally slow down redraws or cause bugs (see urxvt(1)), but it
# seems that when the terminal is present on every workspace, redraws
# are avoided, so we can get away with it for watching logs even if
# not for normal terminal windows.
#
# -is high-intensity styles for bold/blink
# +sk don't scroll to bottom on keypress (irrelevant with -bl ?)
# +sw don't scroll as new lines appear
# +sb turn off scrollbar
# -b 0 reduces border
# -bl totally removes border but stops window from ever gaining focus;
#     it also puts it above everything else for some reason
#      -name XTerm \
urxvt -fn $font -fb $font -is \
      +sk +sw +sb \
      -b 0 \
      -depth 32 -bg rgba:0000/0000/0000/4444 \
      -g ${watchlogs_width}x${watchlogs_height}+0-${bottom_margin} \
      -e watchlogs-system

#rxvt -fn $font +sk +sw -tr -g ${watchlogs_width}x${watchlogs_height}+0-0 \
#     -e watchlogs-system

#aterm -fn $font -fb $font -tr -g ${watchlogs_width}x${watchlogs_height}+0-0 \
#      -e watchlogs-system

#Eterm -t watchlogs-system -g ${watchlogs_width}x${watchlogs_height}+0-0
