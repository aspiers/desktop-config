#!/bin/bash

. $ZDOTDIR/lib/libhost.sh
eval $($ZDOTDIR/lib/libdpy.py)
read_localhost_nickname

layout_file () {
    # echo >&2 "Using $1 layout in ~/.fluxbox/layouts"
    echo ~/.fluxbox/layouts/$1.yaml
    exit
}

# Sometimes xfce4-display-settings doesn't manage to set it to the
# primary for some reason, so set it manually if needed.
ensure_primary_set () {
    find_by="$1" search="$2"

    # Find the desired monitor output name from inxi
    monitor=$(~/lib/libdpy.py --find-by-"$find_by" "$search")
    desired_output=$(echo "$monitor" | jq -r .mapped)

    # Find the current xrandr primary output name
    primary_output=$(~/lib/libdpy.py --find-xrandr-primary | jq -r .name)

    if [[ "$primary_output" == "$desired_output" ]]; then
        : "$desired_output is already primary (according to xrandr)"
        return
    fi
    xrandr --output "$desired_output" --primary
    rm "$XRANDR_CACHE"
    : "Set $desired_output as primary"
}

case "$localhost_nickname" in
    celtic)
        if grep -q 'BenQ BL3200' $INXI_RAW_CACHE; then
            case "`monitors-connected`" in
                2)
                    ensure_primary_set model BenQ
                    layout_file celtic+BenQ
                    ;;
                3)
                    ensure_primary_set model BenQ
                    layout_file celtic+BenQ+Dell
                    ;;
            esac
            exit
        elif large-monitor-connected; then
            echo >&2 "Detected large monitor attached"
            ensure_primary_set res 3840x2160
            layout_file celtic+large
            exit
        # UGLY HACK: relies on inxi cache being created by previous command
        # (large-monitor-connected)
        elif [ `monitors-connected` == 1 ]; then
            # Note: running monitors-connected guarantees presence of
            # $XRANDR_CACHE
            output="$( jq -r .screens[0].name $XRANDR_CACHE )"
            xrandr --output "$output" --primary

            # Could edit the cache like this:
            # jq '.screens[0].primary = "primary"' $XRANDR_CACHE > $XRANDR_CACHE.new
            # mv $XRANDR_CACHE{.new,}
            # but better not to make assumptions about schema, so just invalidate
            rm $XRANDR_CACHE

            layout_file "$localhost_nickname"
            exit
        fi
        ;;
    ionian)
        if [ `monitors-connected` == 2 ]; then
            ensure_primary_set model BenQ
            layout_file "$localhost_nickname"
            exit
        fi
        ;;
    aegean)
        if [ `monitors-connected` == 1 ]; then
            layout_file "$localhost_nickname"
            exit
        fi
        ;;
esac

echo >&2 "ERROR: Couldn't figure out which layout to apply for $localhost_nickname!"
exit 1
